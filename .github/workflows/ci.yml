name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull requests to the main branch

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
      - name: List available simulators
        run: xcrun simctl list devices

      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Step 3: Boot the iPhone 15 Simulator
      - name: Boot iPhone 15 Simulator
        run: xcrun simctl boot 646DB559-041F-448B-8333-0E547C95D3A1

      # Step 4: Run unit tests
      - name: Run unit tests
        run: |
          xcodebuild test \
            -project MusicPlayer.xcodeproj \
            -scheme MusicPlayer \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.4"

      # Step 5: Build the .app for simulators
      - name: Build .app for simulator
        run: |
          xcodebuild build \
            -project MusicPlayer.xcodeproj \
            -scheme MusicPlayer \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.4" \
            -derivedDataPath Build

      # Step 6: Archive the .app as an artifact
      - name: Archive .app
        run: |
          cd Build/Build/Products/Debug-iphonesimulator
          zip -r MusicPlayer.app.zip MusicPlayer.app

      # Step 7: Upload the .app as a build artifact
      - name: Upload .app artifact
        uses: actions/upload-artifact@v4
        with:
          name: MusicPlayer-Simulator
          path: Build/Build/Products/Debug-iphonesimulator/MusicPlayer.app.zip